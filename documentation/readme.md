# Документация по проекту torgi-opendata

## Общее описание

Проект `torgi-opendata` предназначен для загрузки, обработки и хранения открытых данных с портала torgi.gov.ru. Он позволяет работать с данными о торгах, приватизации и нормативно-справочной информации (NSI) через SQLite базу данных.

## Структура проекта

```
torgi-opendata/
├── main.py                 # Основной модуль для работы с планами приватизации
├── masterdata.py           # Модуль для создания и заполнения NSI таблиц
├── createexcel_privplans.py # Модуль для экспорта данных в Excel
├── metadownload.py         # Модуль для загрузки метаданных
├── download_missing_nsi.py # Скрипт для загрузки отсутствующих NSI файлов
├── torgi.db               # SQLite база данных
├── masterdata/            # Каталог с NSI данными
├── privatisationplans/    # Каталог с планами приватизации
├── pyproject.toml         # Конфигурация зависимостей
├── requirements.txt       # Зависимости проекта
└── README.md              # Описание проекта
```

## Структура базы данных

### Таблицы планов приватизации:
- `privatisationplans` - основные данные о планах приватизации
- `privatisationplanlist` - детализация планов приватизации
- `privatizationobjects` - объекты приватизации

### Таблицы NSI (нормативно-справочная информация):
- `nsi_*` - динамически создаваемые таблицы для каждого типа NSI:
  - `nsi_abandonedReason` - причины признания торгов несостоявшимися
  - `nsi_attachmentType` - типы вложений
  - `nsi_contractTerminationReason` - причины прекращения контрактов
  - и другие (всего до 30 различных NSI типов)

## Использование

### 1. Загрузка и обработка планов приватизации

#### Создание базы данных:
```bash
python main.py --createdb
```

#### Загрузка данных о планах приватизации:
```bash
python main.py --privplansupload
```
Эта команда загружает данные из JSON файлов в директории `privatisationplans/` в таблицу `privatisationplans`.

#### Обработка документов:
```bash
python main.py --processdocs
```
Эта команда загружает данные из внешних документов (по ссылкам href) в таблицы `privatisationplanlist` и `privatizationobjects`.

#### Полный процесс загрузки:
```bash
python main.py --createdb --privplansupload --processdocs
```

### 2. Работа с NSI данными

#### Создание NSI таблиц:
```bash
python masterdata.py --createdb
```
Эта команда:
- Загружает структуру NSI из файла `masterdata/data-20220101T0000-20251222T0000-structure-20250101.json`
- Для каждого типа NSI создает отдельную таблицу с префиксом `nsi_`
- Загружает данные из соответствующих локальных JSON файлов
- Обрабатывает сложные структуры данных (массивы, вложенные объекты) путем конвертации в JSON строки

### 3. Автоматизированная загрузка

Скрипт `download_data.zsh` в директории `masterdata/` предоставляет автоматизированный процесс:
- Загрузка метаданных
- Загрузка файлов данных
- Обработка планов приватизации
- Создание NSI таблиц
- Экспорт в Excel

## Особенности реализации

### Обработка NSI данных:
- Скрипт анализирует структуру JSON файлов, где данные находятся в массиве `NSI` внутри объекта `masterData`
- Поддерживаются вложенные структуры данных, которые преобразуются в плоские колонки
- Сложные объекты (массивы, словари) сохраняются как JSON строки
- Отсутствующие файлы обрабатываются без ошибок

### Обработка планов приватизации:
- Поддержка нескольких записей с одинаковым `regnum` (ранее ограничение UNIQUE было удалено)
- Использование `INSERT OR REPLACE` для обновления существующих записей
- Обработка внешних документов по ссылкам `href`
- Поддержка разных типов документов (`planReport`, `privatizationPlan`, и т.д.)

### Обработка ошибок:
- Проверка доступности файлов перед обработкой
- Обработка сетевых ошибок при загрузке
- Логирование пропущенных файлов
- Защита от сбоев при обработке некорректных данных

## Зависимости

Проект требует следующие Python пакеты:
- `requests` - для HTTP запросов
- `sqlite3` - для работы с базой данных (обычно входит в стандартную библиотеку)
- `json` - для обработки JSON данных (обычно входит в стандартную библиотеку)

## Требования

- Python 3.6+
- Доступ к интернету (для загрузки внешних документов)
- Права на запись в рабочую директорию

## Ограничения

- Некоторые NSI типы могут быть недоступны из-за неработающих URL-адресов
- Размер базы данных может значительно увеличиваться при большом объеме данных
- Обработка больших JSON файлов может занимать продолжительное время

## Примеры использования

### Проверка количества записей в таблице:
```sql
SELECT COUNT(*) FROM privatisationplans;
```

### Получение списка уникальных организаций:
```sql
SELECT DISTINCT org_name FROM privatisationplanlist;
```

### Поиск объектов приватизации по региону:
```sql
SELECT name, location FROM privatizationobjects WHERE location LIKE '%Казань%';
```